{% extends "base.html" %}

{% block page-title %}LVS Admin{% endblock %}
{% block content-title %}LVS Admin{% endblock %}


{% block page-content%}
<!--BEGIN MODAL CONFIG PORTLET-->
<div id="modal-config" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" data-dismiss="modal" aria-hidden="true" class="close">
                    &times;</button>
                <h4 class="modal-title">
                    Confirm the deletion</h4>
            </div>
            <div class="modal-body">
                <p>
                    You sure you want to delete?<br/><span id="modal-body-footer"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn btn-default">
                    Close</button>
                <button id="modal-button-delete" type="button" class="btn btn-danger">
                    Delete</button>
            </div>
        </div>
    </div>
</div>
<!--END MODAL CONFIG PORTLET-->
<div class="row mbl">
    <div class="col-lg-6">
        <div class="panel panel-grey">
            <div class="panel-heading">Add virtual server</div>
            <div class="panel-body pan">
                <form id="add_virtual_server" method="post" action="{% url 'ipvsadmin:index'%}">
                    {% csrf_token %}
                    <div class="form-body pal">
                        <div class="form-group">
                            <div class="radio">                            
                                {% for radio in vsform.type%}
                                    {{ radio.tag }}
                                    <label for="{{ radio.id_for_label }}" class="radio-inline">
                                    &nbsp;{{ radio.choice_label }}
                                    </label>
                                {% endfor %}
                            </div>
                            {% include "ipvsadmin/error-div.html" with field=vsform.type only %}
                        </div>
                        <hr />
                        <div class="form-group" id="div_{{vsform.ip.id_for_label}}">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="{{vsform.ip.id_for_label}}" class="control-label">{{vsform.ip.label}}</label>
                                        {{vsform.ip}}
                                        {% include "ipvsadmin/error-div.html" with field=vsform.ip only %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                    <label for="{{vsform.port.id_for_label}}" class="control-label">{{vsform.port.label}}</label>
                                    {{vsform.port}}
                                    {% include "ipvsadmin/error-div.html" with field=vsform.port only %}
                                    </div>
                                </div>
                            </div>
                            <div class="row" id="div_{{vsform.fwmark.id_for_label}}">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="{{vsform.fwmark.id_for_label}}" class="control-label">{{vsform.fwmark.label}}</label>
                                        {{vsform.fwmark}}
                                        {% include "ipvsadmin/error-div.html" with field=vsform.fwmark only %}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                    <label for="{{vsform.scheduler.id_for_label}}" class="control-label">{{vsform.scheduler.label}}</label>
                                    {{vsform.scheduler}}
                                        {% include "ipvsadmin/error-div.html" with field=vsform.scheduler only %}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                    <label for="{{vsform.peristtimeout.id_for_label}}" class="control-label">{{vsform.peristtimeout.label}}</label>
                                    {{vsform.peristtimeout}}
                                        {% include "ipvsadmin/error-div.html" with field=vsform.peristtimeout only %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions text-right pal">
                        <button type="submit" class="btn btn-primary">
                            Add</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="row mbl">
    <div class="col-lg-6">
        <div class="panel panel-green">
            <div class="panel-heading">Ipvsadmin</div>
            <div class="panel-body">
                <table id="ipvs-table" class="table table-hover table-condensed">
                    <thead>
                    <tr>
                        <th>IpVs</th>
                        <th>IP</th>
                        <th>Mode</th>
                        <th>Weight</th>
                        <th/>
                    </tr>
                    </thead>
                    <tbody>
                        {% include "ipvsadmin/ipvsadminboad.html" %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mbl">
    <div class="col-lg-6">
        <div class="note note-warning"><h4 class="box-heading">Warning! Do not use this tool if you use keepalived</h4>
        <p>Keepalived modifies LVS. Any changes made by this interface could be automatically modified by Keepalived.</p></div>
    </div>
</div>
{% endblock %}

{% block page-footer%}
<script>
    //$('#div_{{vsform.fwmark.id_for_label}}').hide('slow')
             
    function refrash_ipvstable_contenet() {
        $('#ipvs-table > tbody').load('{% url 'ipvsadmin:content.ipvsadm.table'%}', function() {
            $('#ipvs-table > tbody > tr > td > a > i[data-weight]').on('click', button_weight_change)
        })  
    }
    
    // bind event to img
    $('#ipvs-table > tbody > tr > td > a > i[data-weight]').on('click', button_weight_change)
    function button_weight_change(event) {
        event.preventDefault();
        var button = $(this)   
        var mode = button.data('mode') 
        var port = button.data('port') 
        var realserv = button.data('realserver')
        var weight = button.data('weight')
        var realsmode = button.data('realsmode')
        
        $.ajax({url: '/ipvsadmin/ajax/weight/'+mode+'/'+port+'/'+realserv+'/'+weight+'/'+realsmode,
        type: 'GET',
                dataType: 'json',
                timeout: 2000,
                success: function(json_data){
                    $('#messages').empty()          
                    refrash_ipvstable_contenet()
                },
                error: function(){
                    $('#messages').empty()           
                    message_error('Some problem with server. Try again') 
                    refrash_ipvstable_contenet()
                }
        })
    }

    $('#modal-config').on('show.bs.modal', function (event) {
        var modal = $(this)                                                    
        var targetButton = $('.modal-footer #modal-button-delete')
                                                         
        var button = $(event.relatedTarget)
        var mode = button.data('mode') 
        var port = button.data('port') 
        var realserv = button.data('realserver') 
        
        // clone data
        targetButton.data('mode',mode)
        targetButton.data('port',port)
        
        var txt = 'Mode: '+mode+' Address:'+port
        if(null != realserv){
            txt += ' Real server: '+realserv
            
           targetButton.data('realserver',realserv)
        }else{
           targetButton.data('realserver',null) 
        }
        
        modal.find('.modal-body #modal-body-footer').text(txt)        
    })
    
    $('.modal-footer #modal-button-delete').on('mousedown', function (event) {
        var targetButton = $('.modal-footer #modal-button-delete')       
        var mode = targetButton.data('mode')
        var port = targetButton.data('port')
        var realserv = targetButton.data('realserver')
        
        if(null == realserv){ 
            $.ajax({url: '/ipvsadmin/ajax/deletevs/'+mode+'/'+port,
                type: 'GET',
                        dataType: 'json',
                        timeout: 2000,
                        success: function(json_data){
                            $('#messages').empty()          
                            message_info('Virtual server has been removed.') 
                            refrash_ipvstable_contenet()
                        },
                        error: function(){
                            $('#messages').empty()           
                            message_error('Some problem with server. Try again') 
                            refrash_ipvstable_contenet()
                        }
                }); 
        }else{
             $.ajax({url: '/ipvsadmin/ajax/deleterealserv/'+mode+'/'+port+'/'+realserv,
                type: 'GET',
                        dataType: 'json',
                        timeout: 2000,
                        success: function(json_data){
                            $('#messages').empty()          
                            message_info('Server has been removed.') 
                            refrash_ipvstable_contenet()
                        },
                        error: function(){
                            $('#messages').empty()           
                            message_error('Some problem with server. Try again') 
                            refrash_ipvstable_contenet()
                        }
                });    
        
        }                                                                  
        $('#modal-config').modal('hide');
    })
</script>

{% endblock %}

